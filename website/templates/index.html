{% extends "base.html" %}

{% block title %}
Home
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Welcome, {{ user.user_name }}</h1>

    <form method="POST" action="{{ url_for('views.add_post') }}">
        <div class="form-group">
            <textarea name="content" class="form-control" rows="3" placeholder="What's on your mind?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Post</button>
    </form>


    <hr>

    <div class="posts">
        {% for post in posts %}
        <div class="card my-3">
            <div class="card-body d-flex justify-content-between align-items-center">
            </div>
        </div>
        <div>
            <p>{{ post.data }}</p>
            <footer class="blockquote-footer">
                Posted by {{ post.user.user_name }} on {{ post.date.strftime('%Y-%m-%d') }}
            </footer>
            <p>Likes: <span class="likes-count">{{ post.likes.count() }}</span></p>
            <button class="like-btn">{% if current_user.id in [like.user_id for like in post.likes] %}Unlike{% else
                %}Like{% endif %}</button>
        </div>
        {% endfor %}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function () {
                const postElement = this.closest('.post');
                const postId = postElement.getAttribute('data-post-id');

                fetch(`/post/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'liked') {
                            this.textContent = 'Unlike';
                        } else {
                            this.textContent = 'Like';
                        }
                        postElement.querySelector('.likes-count').textContent = data.like_count;
                    });
            });
        });
    });
</script>
{% endblock %}